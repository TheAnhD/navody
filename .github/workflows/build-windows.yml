name: Build Windows Electron App

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

# Grant explicit write permission to contents so the built-in GITHUB_TOKEN can create releases
permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    # Expose signing secrets to the job so electron-builder can pick them up.
    # Provide CSC_LINK (PFX file URL or base64) and CSC_KEY_PASSWORD as GitHub Secrets.
    env:
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Ensure NSIS (makensis) is installed
        run: |
          choco feature enable -n allowGlobalConfirmation || true
          choco install -y nsis

      - name: Install dependencies
        run: npm ci

      - name: Pre-download Electron into cache (retries)
        shell: pwsh
        run: |
          $version = node -p "require('electron/package.json').version".Trim()
          Write-Host "Electron version: $version"
          $cache = Join-Path $env:RUNNER_TEMP "electron-cache"
          New-Item -ItemType Directory -Force -Path $cache | Out-Null
          $url = "https://github.com/electron/electron/releases/download/v$version/electron-v$version-win32-x64.zip"
          $dest = Join-Path $cache "electron-v$version-win32-x64.zip"
          $max = 6; $i = 0
          while ($i -lt $max -and -not (Test-Path $dest)) {
            try {
              Write-Host "Downloading Electron (attempt $($i+1)) -> $url"
              Invoke-WebRequest -Uri $url -OutFile $dest -UseBasicParsing -TimeoutSec 240
            } catch {
              Write-Host "Download attempt $($i+1) failed: $($_.Exception.Message)"
              Remove-Item -Force $dest -ErrorAction SilentlyContinue
              Start-Sleep -Seconds (10 * ($i+1))
            }
            $i++
          }
          if (-not (Test-Path $dest)) { Write-Error "Failed to download Electron $version after $max attempts"; exit 1 }
          Write-Host "Downloaded Electron to $dest"

      - name: Verify icon exists
        shell: pwsh
        run: |
          if (Test-Path assets/app.ico) { Write-Host "assets/app.ico present" } else { Write-Host "assets/app.ico missing" }

      - name: Check for ffmpeg.dll (build inclusion)
        shell: pwsh
        run: |
          if (Test-Path build/ffmpeg.dll) { Write-Host "build/ffmpeg.dll present — it will be included in the package." } else { Write-Warning "build/ffmpeg.dll missing. Place the correct x64 ffmpeg.dll at build/ffmpeg.dll so it will be packaged next to the exe." }

      - name: Build Windows artifacts (no publish)
        shell: pwsh
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          # Set ELECTRON_CACHE at runtime
          $env:ELECTRON_CACHE = Join-Path $env:RUNNER_TEMP 'electron-cache'
          Write-Host "ELECTRON_CACHE=$env:ELECTRON_CACHE"
          Write-Host "Signing env CSC_LINK present? -> $([bool]::Parse(([string]::IsNullOrEmpty($env:CSC_LINK) ) -eq $false -as [string]))"
          Write-Host "Starting electron-builder (output => build.log)"
          npx electron-builder --win --x64 --publish never *>&1 | Tee-Object -FilePath build.log
          $exit = $LASTEXITCODE
          Write-Host "electron-builder exit code: $exit"
          exit $exit

      - name: Upload build logs and artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist/
            build.log

      - name: Create Release v1.0.0
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v1.0.0
          release_name: "Návod"
          body: "Release v1.0.0 — Windows portable build"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: release-files

      - name: Upload portable EXE to the Release
        if: always()
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $uploadUrl = '${{ steps.create_release.outputs.upload_url }}'

          if ([string]::IsNullOrEmpty($uploadUrl)) {
            Write-Error "Create Release step did not return an upload_url. The workflow likely lacks permission to create releases (Resource not accessible by integration). Ensure 'permissions: contents: write' is set and this run is not from a fork."
            exit 1
          }

          $artifactDir = 'release-files'

          # Expand any zip artifacts so we can find .exe files inside them
          Get-ChildItem $artifactDir -Recurse -Filter *.zip | ForEach-Object {
            Write-Host "Expanding zip: $($_.FullName)"
            Try { Expand-Archive -Path $_.FullName -DestinationPath ($_.DirectoryName + '\\' + $_.BaseName + '_unzipped') -Force } Catch { Write-Warning "Failed to expand $($_.FullName): $($_.Exception.Message)" }
          }

          $exe = Get-ChildItem $artifactDir -Recurse -Filter *.exe | Select-Object -First 1
          if (-not $exe) { Write-Error "No exe found in $artifactDir after extracting zips"; exit 1 }

          $filePath = $exe.FullName
          $fileName = $exe.Name
          $uploadUrl = ($uploadUrl -replace '\\{.*\\}$','') + "?name=$fileName"
          Write-Host "Uploading $filePath to $uploadUrl"
          $token = $env:GITHUB_TOKEN
          $bytes = [System.IO.File]::ReadAllBytes($filePath)
          $result = Invoke-RestMethod -Uri $uploadUrl -Method Post -Headers @{ Authorization = "token $token"; 'Content-Type' = 'application/octet-stream' } -Body $bytes -UseBasicParsing
          Write-Host "Upload result: $($result | ConvertTo-Json -Depth 3)"

      - name: Post Setup Node.js
        run: echo "Post setup"

      - name: Post Checkout code
        run: echo "Post checkout"
